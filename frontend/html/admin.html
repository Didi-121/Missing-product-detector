<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OXXO Planograms</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,300,0..1,-25&icon_names=arrow_warm_up,close,error,inventory_2,person,published_with_changes,shelves,store" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    <link rel="stylesheet" href="../css/defaults.css">
    <link rel="stylesheet" href="../css/admin.css">



</head>

<body>
    <header>
        <img src="../assets/images/Oxxo_Logo.svg.png" alt="">
        <span class="material-symbols-rounded"> person </span>
        <h3 class="pt-3 pe-5">
            Pedro Paramo
        </h3>
        <span class="material-symbols-rounded"> store </span>
        <h3 class="pt-3">
            10XA00841
        </h3>
    </header>
    <div class="col-12 p-5 row">
        <div class="col-md-7">
            <h3 style="color: #7A7A7A;">Notificaciones
            </h3>
            <div class="notifications-container">

            </div>
            <br><br>
            <div class="row m-0 m-0 mt-md-5">
                <div class="col-md-8">
                    <div class="card" style="background-color:#BB2C2C;border: none;">
                        <div class="card-body row">
                            <div class="col-5 mx-auto">
                                <h4 class="text-center pb-2">Rendimiento de acomodo promedio</h4>
                                <div class="progress-circle mx-auto" data-percentage="75">
                                    <svg viewBox="0 0 100 100">
                                        <circle class="bg" cx="50" cy="50" r="45" />
                                        <circle class="fg" cx="50" cy="50" r="45" />
                                    </svg>
                                    <div class="percentage-text">75%</div>
                                </div>
                            </div>
                            <div class="col-5 mx-auto">
                                <h4 class="text-center pt-3">Ultimo análisis hace</h4>
                                <div class="last-hour">
                                    9h
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-7 col-md-4 mt-5 mt-md-0 mx-auto">
                    <button class="btn-inventary py-3">
                        <span class="material-symbols-rounded">inventory_2</span>
                        Inventario
                    </button>
                </div>
            </div>
        </div>
        <div class="col-md-4 ms-auto">
            <h3 style="color: #7A7A7A;">Anaqueles</h3>
            <div class="anaqueles-container">

            </div>
        </div>
</body>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO"
    crossorigin="anonymous"></script>
<script src="../assets/frameworks/jquery/jquery-3.7.1.min"></script>
<script>
    const circles = document.querySelectorAll(".progress-circle");

    circles.forEach(el => {
        const percent = el.dataset.percentage;
        const circle = el.querySelector(".fg");
        const radius = circle.r.baseVal.value;
        const circumference = 2 * Math.PI * radius;

        circle.style.strokeDasharray = circumference;
        circle.style.strokeDashoffset = circumference; // empieza vacío

        setTimeout(() => {
            const offset = circumference - (percent / 100) * circumference;
            circle.style.strokeDashoffset = offset;
        }, 100); // pequeña pausa para que el cambio sea visible

        el.querySelector(".percentage-text").textContent = `${percent}%`;
    });
</script>
<script>
    /*
        fetch('../php/processors/getNotifications.php', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                type: 'Alerta',
                content: 'Producto vencido',
                anaquel: 3,
                fecha: '2025-05-17'
            })
        })
            .then(res => res.json())
            .then(data => console.log(data))
            .catch(err => console.error(err));
    */
</script>
<script>
    $(document).ready(function () {


        fetch('../php/processors/getNotifications.php', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            }
        })
            .then(res => res.json())
            .then(function (data) {
                data.forEach(notification => {
                    const fecha = new Date(notification.date);
                    const today = new Date();
                    const months = [
                        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
                        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
                    ];
                    function formatearHoraAMPM(fecha) {
                        const horas = fecha.getHours();
                        const minutos = fecha.getMinutes().toString().padStart(2, '0');
                        const ampm = horas >= 12 ? 'pm' : 'am';
                        const hora12 = horas % 12 || 12;
                        return `${hora12}:${minutos} ${ampm}`;
                    }
                    if (fecha.getDay() == today.getDay() && fecha.getMonth() == today.getMonth() && fecha.getFullYear() == today.getFullYear()) {
                        notification.date = "Hoy " + formatearHoraAMPM(fecha);
                    } else if (fecha.getDay() == today.getDay() - 1 && fecha.getMonth() == today.getMonth() && fecha.getFullYear() == today.getFullYear()) {
                        notification.date = "Ayer " + formatearHoraAMPM(fecha);
                    } else if (fecha.getFullYear() == today.getFullYear()) {
                        notification.date = fecha.getDate() + " de " + (months[fecha.getMonth()]);
                    } else {
                        notification.date = fecha.getDate() + " de " + (months[fecha.getMonth()]) + " del " + fecha.getFullYear();
                    }
                    $('.notifications-container').append(`
                <div class="notification ${notification.type}" data-id="${notification.id}">
                    <span class="material-symbols-rounded main-icon pe-3"> ${notification.icon} </span>
                    <div class="info">
                        <div class="head">
                            <h4 class="pt-1">${notification.title}</h4>
                            <span class="ps-2"> ${notification.date}</span>
                        </div>
                        <p class="m-0">${notification.content}</p>
                    </div>
                    <span class="material-symbols-rounded close ms-auto"> close </span>
                </div>
            `);

                });
                $('.close').click(function () {
                    const notificationId = $(this).parent().data('id');
                    fetch('../php/processors/deleteNotification.php', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ id: notificationId })
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                $(`.notification[data-id="${notificationId}"]`).remove();
                            } else {
                                console.error('Error deleting notification:', data.error);
                            }
                        })
                        .catch(err => console.error(err));
                });
            })
            .catch(err => console.error(err));

        $.ajax({
            type: "GET",
            url: "../php/processors/getAnaquelesPercentage.php",
            dataType: "json",
            success: function (response) {
                for (let i = 1; i < response.length; i++) {
                    for (let j = 0; j < response.length; j++) {
                        const element = response[j];
                        function diferenciaConAhora(fechaStr) {
                            const ahora = new Date();
                            const fecha = new Date(fechaStr);
                            const msDiff = Math.abs(ahora - fecha);

                            const segundos = Math.floor(msDiff / 1000);
                            const minutos = Math.floor(segundos / 60);
                            const horas = Math.floor(minutos / 60);
                            const dias = Math.floor(horas / 24);
                            const meses = Math.floor(dias / 30); // aproximado

                            if (meses >= 1) return `${meses} mes${meses > 1 ? 'es' : ''}`;
                            if (dias >= 1) return `${dias} día${dias > 1 ? 's' : ''}`;
                            if (horas >= 1) return `${horas} hora${horas > 1 ? 's' : ''}`;
                            if (minutos >= 1) return `${minutos} minuto${minutos > 1 ? 's' : ''}`;
                            return `${segundos} segundo${segundos > 1 ? 's' : ''}`;
                        }
                        var diferencia = diferenciaConAhora(element.date);
                        if (element.anaquel_id == i) {

                            $(".anaqueles-container").append(`
                            <a href="../php/AnaquelAdmin.php?id=`+ element.anaquel_id + `">
                                <div class="anaquel">
                                    <span class="material-symbols-rounded main-icon"> shelves</span>
                                    <div class="data me-5">
                                        <h4 class="m-0">Anaquel `+ element.anaquel_id + `</h4>
                                        <p class="m-0">Ultimo análisis hace <span class="primary">`+ diferencia + `</span></p>
                                    </div>
                                    <div class="percentage">
                                        `+ element.percentage + "%" + `
                                    </div>
                                </div>
                            </a>
                            `);
                            $(".anaqueles-container").append("<div class='thin-bar'></div>");
                            break;
                        }
                    }
                }
            },
            error: function (error) {
                console.error("Error:", error);
            }
        });
    });



</script>

</html>